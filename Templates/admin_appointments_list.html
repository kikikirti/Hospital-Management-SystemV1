{% extends "base.html" %}
{% block title %}Appointments{% endblock %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="h4 mb-0" id="appointments">All Appointments</h2>
    <span class="text-muted small">Manage appointment lifecycle</span>
</div>

<!-- ðŸ” Search bar -->
<section id="appointments-search" class="mb-3">
    <form method="get" class="row g-2 align-items-end">
        <div class="col-md-6">
            <label for="q" class="form-label mb-1">Search</label>
            <input
                type="text"
                id="q"
                name="q"
                class="form-control form-control-sm"
                placeholder="Search by doctor, patient, status, or date (YYYY-MM-DD)"
                value="{{ q or '' }}"
            >
        </div>
        <div class="col-md-auto">
            <button type="submit" class="btn btn-sm btn-outline-primary mt-3 mt-md-0">
                Search
            </button>
        </div>
        <div class="col-md-auto">
            <a href="{{ url_for('admin.appointments_list') }}"
               class="btn btn-sm btn-outline-secondary mt-3 mt-md-0">
                Clear
            </a>
        </div>
    </form>
</section>

<section id="table">
    <div class="card shadow-sm">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped table-hover table-sm mb-0 align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>#</th>
                            <th>Date</th>
                            <th>Time</th>
                            <th>Status</th>
                            <th>Doctor</th>
                            <th>Patient</th>
                            <th>Diagnosis</th>
                            <th>Prescription</th>
                            <th>Notes</th>
                            <th class="text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for appointment in appointments %}
                        <tr id="appointment-{{ appointment.id }}">
                            <td>{{ appointment.id }}</td>
                            <td>{{ appointment.appt_date }}</td>
                            <td>{{ appointment.appt_time }}</td>
                            <td>
                                {% if appointment.status == "Booked" %}
                                    <span class="badge text-bg-primary">Booked</span>
                                {% elif appointment.status == "Completed" %}
                                    <span class="badge text-bg-success">Completed</span>
                                {% elif appointment.status == "Cancelled" %}
                                    <span class="badge text-bg-secondary">Cancelled</span>
                                {% else %}
                                    <span class="badge text-bg-light text-muted">{{ appointment.status }}</span>
                                {% endif %}
                            </td>
                            <td>
                                {{ appointment.doctor.user.name if appointment.doctor and appointment.doctor.user else 'N/A' }}
                            </td>
                            <td>
                                {{ appointment.patient.user.name if appointment.patient and appointment.patient.user else 'N/A' }}
                            </td>
                            <td>{{ appointment.treatment.diagnosis if appointment.treatment else '-' }}</td>
                            <td>{{ appointment.treatment.prescription if appointment.treatment else '-' }}</td>
                            <td>{{ appointment.treatment.notes if appointment.treatment else '-' }}</td>

                            <td class="text-end">
                                <div class="table-actions">
                                    {% if appointment.status == "Booked" %}
                                        <!-- Complete -->
                                        <form action="{{ url_for('admin.appointment_set_status', appt_id=appointment.id) }}"
                                              method="post">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                            <input type="hidden" name="status" value="Completed">
                                            <button type="submit" class="btn btn-sm btn-outline-success">
                                                Complete
                                            </button>
                                        </form>

                                        <!-- Cancel (only status=Cancelled POST for tests) -->
                                        <form action="{{ url_for('admin.appointment_set_status', appt_id=appointment.id) }}"
                                              method="post">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                            <input type="hidden" name="status" value="Cancelled">
                                            <button type="submit" class="btn btn-sm btn-outline-warning">
                                                Cancel
                                            </button>
                                        </form>

                                    {% elif appointment.status == "Completed" %}
                                        <!-- Reopen from Completed -->
                                        <form action="{{ url_for('admin.appointment_set_status', appt_id=appointment.id) }}"
                                              method="post">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                            <input type="hidden" name="status" value="Booked">
                                            <button type="submit" class="btn btn-sm btn-outline-secondary">
                                                Reopen
                                            </button>
                                        </form>

                                    {% elif appointment.status == "Cancelled" %}
                                        <!-- Reopen from Cancelled -->
                                        <form action="{{ url_for('admin.appointment_set_status', appt_id=appointment.id) }}"
                                              method="post">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                            <input type="hidden" name="status" value="Booked">
                                            <button type="submit" class="btn btn-sm btn-outline-secondary">
                                                Reopen
                                            </button>
                                        </form>
                                    {% endif %}

                                    <!-- Delete -->
                                    <form action="{{ url_for('admin.appointment_delete', appt_id=appointment.id) }}"
                                          method="post"
                                          onsubmit="return confirm('Are you sure you want to delete this appointment with id {{ appointment.id }} ?');">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <button type="submit" class="btn btn-sm btn-outline-danger">
                                            Delete
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                    {% else %}
                        <tr>
                            <td colspan="10" class="text-center text-muted py-3">
                                No appointments found.
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</section>

{% endblock %}
